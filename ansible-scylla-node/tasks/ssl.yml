---
- set_fact:
    _localhost_cert_path: "{{ scylla_ssl.localhost_cert_path | default(inventory_dir) }}"

- name: For every node, check if crt file exists
  stat:
    path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}.crt"
  register: _node_crt
  delegate_to: localhost

- name: For every node, check if key file exists
  stat:
    path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}.pem"
  register: _node_key
  delegate_to: localhost

# FIXME: You need to decide if it's ok to have certs without having CA or not
# A weird situation would be if the user has a trustore registered in their application
# but forgot to add it to the metadata. We would create a new truststore and use it for new nodes..

- name: Check if CA exists
  block:
    - name: Check if CA crt file exists
      stat:
        path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.crt"
      register: _ca_crt
    - name: Check if CA key file exists
      stat:
        path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.pem"
      register: _ca_key
    - set_fact:
        _ca_crt_and_key_exist: "{{ _ca_crt.stat.exists|bool and _ca_key.stat.exists|bool }}"
  delegate_to: localhost
  run_once: true

- name: If crt and keys were not provided for all nodes and no CA was provided, generate a self-signed CA
  block:
    - name: Create dir for the CA
      file:
        path: "{{ localhost_ca_cert_path }}"
        state: directory

    - name: Generate an OpenSSL private key for the CA.
      openssl_privatekey:
        path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.pem"

    - name: Generate an OpenSSL Certificate Signing Request for the CA
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.pem"
        common_name: "{{ scylla_cluster_name }}.internal"
        use_common_name_for_san: false  # since we do not specify SANs, don't use CN as a SAN
        basic_constraints:
          - 'CA:TRUE'
        basic_constraints_critical: yes
        key_usage:
          - keyCertSign
        key_usage_critical: true
      register: ca_csr

    - name: Generate a Self Signed OpenSSL certificate for the CA
      community.crypto.x509_certificate:
        path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.crt"
        privatekey_path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.pem"
        csr_content: "{{ ca_csr.csr }}"
        provider: selfsigned
  when: use_acme_ca|bool == False and _ca_crt_and_key_exist == False
  delegate_to: localhost
  run_once: true

- name: Generate CSR
  block:
    # FIXME: What happens if the dir already exists
    - name: Create a directory for the key
      file:
        path: "{{ localhost_cert_path }}"
        state: directory
      delegate_to: localhost

    - name: Generate an OpenSSL private key.
      openssl_privatekey:
        path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}.pem"
      when: _node_key.exists == False
      delegate_to: localhost

    - name: Generate an OpenSSL Certificate Signing Request
      openssl_csr:
        path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}.csr"
        privatekey_path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}.pem"
        common_name: "{{ scylla_ssl.cert_common_name }}"
      delegate_to: localhost
  when: use_acme_ca|bool == False

- name: Generate an OpenSSL certificate signed with our CA certificate
  openssl_certificate:
    path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}/scylla.crt"
    csr_path: "{{ localhost_cert_path }}/{{ scylla_ssl.cert_filename }}/scylla.csr"
    ownca_path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.crt"
    ownca_privatekey_path: "{{ localhost_ca_cert_path }}/{{ scylla_ssl.ca_cert_filename }}.pem"
    provider: ownca
  delegate_to: localhost
  when:
    - scylla_ssl.use_acme_ca is not defined or scylla_ssl.use_acme_ca|bool == false
    - _node_crt.exists == False

# FIXME: Move this to a separate task, since it'll be used twice
- name: Use ACME account for signing the certificates
  block:
    - name: Create a DNS-01 challenge
      acme_certificate:
        acme_version: 2
        account_key_src: "{{ acme_account_key }}"
        account_email: "{{ acme_account_email }}"
        src: "{{ scylla_ssl.localhost_node_cert_path }}/scylla.csr"
        cert: "{{ scylla_ssl.localhost_node_cert_path }}/scylla.crt"
        challenge: dns-01
        #acme_directory: https://acme-v01.api.letsencrypt.org/directory
        acme_directory: https://acme-staging-v02.api.letsencrypt.org/directory
        terms_agreed: yes
        # Renew if the certificate is at least 30 days old
        remaining_days: "{{ acme_renew_after_in_days|int }}"
      register: dns_challenge
  when: scylla_ssl.use_acme_ca is defined and scylla_ssl.use_acme_ca|bool
  delegate_to: localhost

# FIXME: Move this to a separate task that we'll include depending on the value of scylla_ssl.dns_provider
# If it's GCP, then we'll include GCP task
- name: create a resource record set
  gcp_dns_resource_record_set:
    name: "{{ dns_challenge.challenge_data[scylla_ssl.common_name]['dns-01'].record }}."
    managed_zone: "{{ scylla_ssl.dns_zone }}"
    type: TXT
    ttl: 600
    target:
    - "{{ dns_challenge.challenge_data[scylla_ssl.common_name]['dns-01'].resource_value }}"
    project: skilled-adapter-452
    auth_kind: "application"
    state: present
  run_once: true
  delegate_to: localhost
  when: dns_challenge is changed and scylla_ssl.common_name in dns_challenge.challenge_data


- name: Let the challenge be validated and retrieve the cert and intermediate certificate
  acme_certificate:
    acme_version: 2
    account_key_src: "{{ scylla_ssl.acme_account_key }}"
    account_email: "{{ scylla_ssl.acme_account_email }}"
    src: "{{ scylla_ssl.localhost_node_cert_path }}/scylla.csr"
    cert: "{{ scylla_ssl.localhost_node_cert_path }}/scylla.crt"
    fullchain: "{{ scylla_ssl.localhost_node_cert_path }}/scylla-fullchain.crt"
    chain: "{{ scylla_ssl.localhost_node_cert_path }}/scylla-intermediate.crt"
    challenge: dns-01
    acme_directory: https://acme-staging-v02.api.letsencrypt.org/directory
    remaining_days: 30
    data: "{{ dns_challenge }}"
  when: scylla_ssl.use_acme_ca is defined and scylla_ssl.use_acme_ca|bool
  delegate_to: localhost
